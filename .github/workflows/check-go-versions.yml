name: Check Go Versions

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - branch: main
            track: "1.24"
            type: stable
          - branch: "1.25"
            track: "1.25"
            type: stable
          - branch: "1.26"
            track: "1.26"
            type: prerelease

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Resolve current and latest version
        id: ver
        env:
          TRACK: ${{ matrix.track }}
          TYPE: ${{ matrix.type }}
        run: |
          set -euo pipefail

          CURRENT_MAJOR_MINOR=$(sed -n 's/^GO_VERSION_MAJOR_MINOR:=//p' golang/Makefile | head -n1)
          CURRENT_PATCH=$(sed -n 's/^GO_VERSION_PATCH:=//p' golang/Makefile | head -n1)
          if [ -n "$CURRENT_PATCH" ]; then
            CURRENT_VERSION="${CURRENT_MAJOR_MINOR}.${CURRENT_PATCH}"
          else
            CURRENT_VERSION="$CURRENT_MAJOR_MINOR"
          fi

          if [ "$TYPE" = "stable" ]; then
            LATEST_VERSION=$(curl -fsSL "https://go.dev/dl/" | grep -oE "go${TRACK}\.[0-9]+" | sort -V | tail -1 | sed 's/^go//')
          else
            LATEST_VERSION=$(curl -fsSL "https://go.dev/dl/" | grep -oE "go${TRACK}(\.[0-9]+|rc[0-9]+|beta[0-9]+)" | sort -V | tail -1 | sed 's/^go//')
          fi

          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
          if [ -n "$LATEST_VERSION" ] && [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "needs=true" >> $GITHUB_OUTPUT
          else
            echo "needs=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve hash
        id: hash
        if: steps.ver.outputs.needs == 'true'
        run: |
          set -euo pipefail
          VER="${{ steps.ver.outputs.latest }}"
          HASH=$(curl -fsSL "https://go.dev/dl/go${VER}.src.tar.gz" | sha256sum | awk '{print $1}')
          echo "value=$HASH" >> $GITHUB_OUTPUT

      - name: Update Makefile
        if: steps.ver.outputs.needs == 'true'
        run: |
          set -euo pipefail
          VER="${{ steps.ver.outputs.latest }}"
          HASH="${{ steps.hash.outputs.value }}"
          MAJOR_MINOR=$(echo "$VER" | sed -E 's/^([0-9]+\.[0-9]+).*/\1/')
          PATCH=$(echo "$VER" | sed -En 's/^[0-9]+\.[0-9]+\.([0-9]+)$/\1/p')

          if [ "${{ matrix.type }}" = "stable" ]; then
            sed -i "s/^GO_VERSION_MAJOR_MINOR:=.*/GO_VERSION_MAJOR_MINOR:=$MAJOR_MINOR/" golang/Makefile
            sed -i "s/^GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=$PATCH/" golang/Makefile
          else
            sed -i "s/^GO_VERSION_MAJOR_MINOR:=.*/GO_VERSION_MAJOR_MINOR:=$VER/" golang/Makefile
            sed -i "s/^GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=/" golang/Makefile
          fi

          sed -i "s/^PKG_HASH:=.*/PKG_HASH:=$HASH/" golang/Makefile

      - name: Commit and push
        if: steps.ver.outputs.needs == 'true'
        run: |
          set -euo pipefail
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add golang/Makefile

          if git diff --cached --quiet; then
            echo "No file change, skip commit"
            exit 0
          fi

          git commit -m "golang: update to ${{ steps.ver.outputs.latest }}"
          git push origin "${{ matrix.branch }}"

      - name: Update summary
        run: |
          echo "branch=${{ matrix.branch }}"
          echo "current=${{ steps.ver.outputs.current }}"
          echo "latest=${{ steps.ver.outputs.latest }}"
          echo "needs=${{ steps.ver.outputs.needs }}"

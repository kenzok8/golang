name: Check Go Versions

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  check-main:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - id: check
        run: |
          CURRENT=$(sed -n '2p' golang/Makefile | cut -d= -f2)
          LATEST=$(curl -sL "https://go.dev/dl/" | grep -oP "go1\.24\.\d+" | sort -V | tail -1 | sed 's/go//')
          if [ "$CURRENT" != "$LATEST" ]; then echo "version=1.24.${LATEST}" >> $GITHUB_OUTPUT; echo "needs=true" >> $GITHUB_OUTPUT; fi
      - id: hash
        if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          echo "hash=$(curl -sL "https://go.dev/dl/go${VER}.src.tar.gz" | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
      - if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          HASH="${{ steps.hash.outputs.hash }}"
          sed -i "s/GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=${VER#1.24.}/" golang/Makefile
          sed -i "s/PKG_HASH:=.*/PKG_HASH:=$HASH/" golang/Makefile
      - if: steps.check.outputs.needs == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add golang/Makefile
          git commit -m "golang: update to ${{ steps.check.outputs.version }}"
          git push origin main

  check-1.25:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 1.25
      - id: check
        run: |
          CURRENT=$(sed -n '2p' golang/Makefile | cut -d= -f2)
          LATEST=$(curl -sL "https://go.dev/dl/" | grep -oP "go1\.25\.\d+" | sort -V | tail -1 | sed 's/go//')
          if [ "$CURRENT" != "$LATEST" ]; then echo "version=1.25.${LATEST}" >> $GITHUB_OUTPUT; echo "needs=true" >> $GITHUB_OUTPUT; fi
      - id: hash
        if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          echo "hash=$(curl -sL "https://go.dev/dl/go${VER}.src.tar.gz" | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
      - if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          HASH="${{ steps.hash.outputs.hash }}"
          sed -i "s/GO_VERSION_PATCH:=.*/GO_VERSION_PATCH:=${VER#1.25.}/" golang/Makefile
          sed -i "s/PKG_HASH:=.*/PKG_HASH:=$HASH/" golang/Makefile
      - if: steps.check.outputs.needs == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add golang/Makefile
          git commit -m "golang: update to ${{ steps.check.outputs.version }}"
          git push origin 1.25

  check-1.26:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.version }}
      hash: ${{ steps.hash.outputs.hash }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: 1.26
      - id: check
        run: |
          CURRENT=$(sed -n '1p' golang/Makefile | cut -d= -f2)
          LATEST=$(curl -sL "https://api.github.com/repos/golang/go/releases" | grep -oP '"'"'tag_name'"'"':\s*"'"'"'\Kgo1\.26[^"]*' | head -1 | sed 's/go//')
          if [ "$CURRENT" != "$LATEST" ]; then echo "version=$LATEST" >> $GITHUB_OUTPUT; echo "needs=true" >> $GITHUB_OUTPUT; fi
      - id: hash
        if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          echo "hash=$(curl -sL "https://go.dev/dl/go${VER}.src.tar.gz" | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
      - if: steps.check.outputs.needs == 'true'
        run: |
          VER="${{ steps.check.outputs.version }}"
          HASH="${{ steps.hash.outputs.hash }}"
          sed -i "s/GO_VERSION_MAJOR_MINOR:=.*/GO_VERSION_MAJOR_MINOR:=$VER/" golang/Makefile
          sed -i "s/PKG_HASH:=.*/PKG_HASH:=$HASH/" golang/Makefile
      - if: steps.check.outputs.needs == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add golang/Makefile
          git commit -m "golang: update to ${{ steps.check.outputs.version }}"
          git push origin 1.26
